class StatController < ApplicationController

  $daysBack = 30
 
  def panel
	
	
	now = DateTime.now
	if !params[:last]
		@activities = Activity.showResults(now-$daysBack, now)
	end
	
	if params[:last]			
		@activities = Activity.showResults(now-params[:numberOfDays].to_i, now)
	end
	
  end

  def results
	
  end

  def details
	if params[:back]
		redirect_to :action => "panel"
	end
	
	# generowanie poprawnej skladniowo daty dla wyciagniecie szczegolow konkretnego dnia 
	dateInput = params[:date].to_s
	year = (dateInput[0,4]).to_i
	month = (dateInput[5,2]).to_i
	day = (dateInput[8,2]).to_i
	
	date = DateTime.new(year,month,day)
	# ---------------------------------

	# pobranie tablicy aktywnosci
	activityModelInput = Activity.showDay(date, date + 23.hours + 59.minutes + 59.seconds )
	# -----------------------------

	# tworzenie prototypow dla aktywnosci
	activitiesArray = Array.new()
	activity = Array.new()
	# ---------------------------


	activityModelInput.each do |ami|
		
		# sprawdzanie danych aktywnosci
		if (ami.repeat==nil)
			repeat = "f"
		else
			repeat = "T"
		end
		@showdate = (ami.created_at.to_s)[0,10]
		# -------------------------------		
		
		# wyciaganie danych Usera
		id = ami.author_id.to_s
		userModelInput = User.findById(id)
		email = " - "
		type = " - "
		fanPageName = " - "
		
		userModelInput.each do |uam|
			if ( uam._id.to_s == id )
				if ( uam._type.to_s == "User" )				
					type = "U"				
					email = uam.email
				else
					type = "F"
					fanPageName = uam.name
				end
			end
		end
		# --------------------------------
		
		# tworzenie tablicy z aktywnosciami dla widoku
		activity = Array({
			:time => (ami.created_at.to_s)[11,8],
			:link => "https://my.dropsport.com/activities/"+ami._id+"",
			:discipline => ami.discipline,
			:author_info => ami.author_info["name"],
			:client => ami.client,
			:enrolled => ami.enrolled_users.size,
			:repeat => repeat,
			:email => email,
			:type => type,
			:fanPageName => fanPageName
		})
		activitiesArray.push(activity)
		# -----------------------------------
	end
	
	# udostepnianie widokowi tablicy aktywnosci	
	@activityDetails = activitiesArray
	# ------------------------------------------

	
  end
end
